{% extends base.html %}

{% block title %}Target Manager{% end %}

{% block includes %}
<script type="text/javascript" charset="utf-8" src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/dataTables.bootstrap.js"></script>
<link href="/static/css/dataTables.bootstrap.css" rel="stylesheet">
{% end %}

{% block content %}
<div class="row">
    <!-- Input area to add new targets -->
    <div class="col-md-6">
        <div class="row">
            <h3>Add Targets</h3>
            <div class="col-md-10">
                    <textarea id="newTargetUrls" type="text" class="form-control" placeholder="Targets seperated by new line">
                    </textarea>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-2">
                <button class="btn btn-primary" type="button" onclick="newTargets($('#newTargetUrls').val());">Add Targets!</button>
            </div>
        </div>
    </div>
    <!-- End Input area for new targets -->
    <!-- Target list -->
    <div class="col-md-6">
        <div class="row-fluid">
            <div class="col-md-12">
                <button class="btn btn-success pull-right" data-toggle="modal" data-target="#pluginLaunchModal"><i class="fa fa-flash"></i> Run Plugins </button>
            </div>
        </div>
        <br>
        <div class="row-fluid">
            <div class="col-md-12">
                <table id='targetTable' class="table table-striped table-condensed">
                    <thead>
                        <tr>
                            <td><input type="checkbox" id="targetTableSelectAllCheckbox" onclick="toggleAll(this);"/></td>
                            <td>Target</td>
                            <td>Actions</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- End Target list -->
</div>

{% module Template("plugin_launcher.html",
    plugin_launch_modal_id="pluginLaunchModal",
    plugins_api_url="mySpace.plugins_api_url",
    worklist_post_func="postToWorkList") %}

<script>
var mySpace = {
                    targets_api_url:"{{ targets_api_url }}",
                    targets_ui_url:"{{ targets_ui_url }}",
                    plugins_api_url:"{{ plugins_api_url }}?group=web&group=net",
                    worklist_api_url:"{{ worklist_api_url }}"
                  };

// Toggle all checkboxes when select all is clicked
function toggleAll(checkbox){
    var table= $(checkbox).closest('table');
    $('td input:checkbox',table).prop('checked',checkbox.checked);
}

function getSelectedTargets() {
    var individualTargets = $('input:checkbox:checked', $('#targetTable').dataTable().fnGetNodes());
    var targets = [];
    $.each(individualTargets, function(index, checkbox) {
        var checkbox = $(checkbox);
        targets.push(checkbox.attr("target-id"));
    });
    return(targets);
}

// Main function that posts using API to launch plugins
function postToWorkList(selectedPluginData){
    selectedPluginData["ID"] = getSelectedTargets();
    $.ajax({
            url:mySpace.worklist_api_url,
            type:'POST',
            data:$.param(selectedPluginData, true),
            success:pluginLaunchSuccess,
            error:function(xhr, textStatus, serverResponse){
                alertFail("Server replied: "+serverResponse);
                }
            });
}

// Close the modal when plugins are launched successfully
function pluginLaunchSuccess(){
    $('#pluginLaunchModal').modal('hide');
    alertSuccess("Selected plugins launched, please check worklist to manage :D");
}

// Function that adds targets to the target list(table infact)
function addTargets(data, status, xhr){
    jQuery('#targetTable').dataTable().fnClearTable();
    $.each(data, function(index, obj){
            jQuery('#targetTable').dataTable().fnAddData([
                                                '<input type="checkbox" target-id="'+obj.ID+'"/>',
                                                '<a href="'+mySpace.targets_ui_url+obj.ID+'">'+obj.TARGET_URL+' ('+obj.HOST_IP+') </a>',
                                                '<a href="#" onclick="deleteTarget('+obj.ID+');"><span class="btn btn-xs btn-danger"><i class="fa fa-times"></i></span></a>'
                                                ]);
            });
}

// Function used to update targets in the list, useful when new targets are added so that table can be updated
function updateTargets(){
    $.getJSON( mySpace.targets_api_url, addTargets);
}

// Delete target with id using API
function deleteTarget(target_id) {
    $.ajax({
            url:mySpace.targets_api_url+target_id,
            type:'DELETE',
            success:updateTargets,
            error:function(xhr, textStatus, serverResponse){
                alertFail("Server replied: "+serverResponse);
                }
            });
}

function isUrl(str) {
    // TODO: Add all url protocols to support net plugins
    var urlPattern = /(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/;
    return urlPattern.test(str);
}

// Add new targets using API
function newTargets(targetUrlsString) {
    var lines = targetUrlsString.split('\n');
    var targetUrls = [];

    // Check if each line is a valid url, and add protocols if only host name is provided
    $.each(lines, function(index, line) {
        if (isUrl(line)) { // Check if a valid url
            targetUrls.push(line);
        } else if (isUrl("http://"+line)) { // If not valid url and adding http:// makes it a valid url
            targetUrls.push("http://"+line);
            targetUrls.push("https://"+line);
        } else { // Not a valid url
            alertFail(targetUrl+" is not a valid url");
        }
    });

    // Since we only have valid urls now in targetUrls, add them using api
    $.each(targetUrls, function(index, targetUrl) {
        $.ajax({
                url:mySpace.targets_api_url,
                type:'POST',
                data:{TARGET_URL:targetUrl},
                success:updateTargets,
                error:function(xhr, textStatus, serverResponse){
                    alertFail("Unable to add "+targetUrl);
                    }
        });
    });
}

// The target list table has to be initialized first
$(document).ready(function() {
    $('#targetTable').dataTable({
        "bAutoWidth": false,
        "columnDefs": [{
          "targets": [0, 2],
          "orderable": false
        }],
        "fnDrawCallback": function( settings ) {
            // Managing the "Select all" checkbox
            // everytime the table is drawn, it checks if all the
            // checkboxes are checked and if they are, then the select all
            // checkbox in the table header is selected
            var allChecked = true;
            $('#targetTable tbody tr').each(function() {
                $(this).find(':checkbox').each(function(){
                    if (!$(this).is(':checked')) allChecked = false;
                });
            });
            $('#targetTableSelectAllCheckbox').prop('checked', allChecked);
        },
    });
    updateTargets();
});
</script>
{% end %}
